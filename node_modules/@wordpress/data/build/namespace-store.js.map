{"version":3,"sources":["/Users/riad/Workspace/a8c/gutenberg/packages/data/src/namespace-store.js"],"names":["createNamespace","key","options","registry","reducer","store","createReduxStore","selectors","actions","resolvers","mapActions","mapSelectors","fulfillment","getCoreDataFulfillment","result","mapResolvers","getSelectors","getActions","subscribe","listener","lastState","getState","state","hasChanged","enhancers","promise","window","__REDUX_DEVTOOLS_EXTENSION__","push","name","instanceId","createStateSelector","selector","runSelector","argsLength","arguments","length","args","Array","i","createBoundAction","action","dispatch","mapSelector","selectorName","resolver","fulfillSelector","isFulfilled","hasStarted","start","fulfill","finish","mappedResolvers","resolverFulfill","select","hasStartedResolution","startResolution","finishResolution","fulfillWithRegistry","namespace","stores"],"mappings":"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","sourcesContent":["/**\n * External dependencies\n */\nimport { createStore, applyMiddleware } from 'redux';\nimport {\n\tflowRight,\n\tget,\n\tmapValues,\n} from 'lodash';\n\n/**\n * Internal dependencies\n */\nimport promise from './promise-middleware';\nimport createResolversCacheMiddleware from './resolvers-cache-middleware';\n\n/**\n * Creates a namespace object with a store derived from the reducer given.\n *\n * @param {string} key              Identifying string used for namespace and redex dev tools.\n * @param {Object} options          Contains reducer, actions, selectors, and resolvers.\n * @param {Object} registry         Temporary registry reference, required for namespace updates.\n *\n * @return {Object} Store Object.\n */\nexport default function createNamespace( key, options, registry ) {\n\tconst reducer = options.reducer;\n\tconst store = createReduxStore( reducer, key, registry );\n\n\tlet selectors, actions, resolvers;\n\tif ( options.actions ) {\n\t\tactions = mapActions( options.actions, store );\n\t}\n\tif ( options.selectors ) {\n\t\tselectors = mapSelectors( options.selectors, store );\n\t}\n\tif ( options.resolvers ) {\n\t\tconst fulfillment = getCoreDataFulfillment( registry, key );\n\t\tconst result = mapResolvers( options.resolvers, selectors, fulfillment, store );\n\t\tresolvers = result.resolvers;\n\t\tselectors = result.selectors;\n\t}\n\n\tconst getSelectors = () => selectors;\n\tconst getActions = () => actions;\n\n\t// Customize subscribe behavior to call listeners only on effective change,\n\t// not on every dispatch.\n\tconst subscribe = store && function( listener ) {\n\t\tlet lastState = store.getState();\n\t\tstore.subscribe( () => {\n\t\t\tconst state = store.getState();\n\t\t\tconst hasChanged = state !== lastState;\n\t\t\tlastState = state;\n\n\t\t\tif ( hasChanged ) {\n\t\t\t\tlistener();\n\t\t\t}\n\t\t} );\n\t};\n\n\t// This can be simplified to just { subscribe, getSelectors, getActions }\n\t// Once we remove the use function.\n\treturn {\n\t\treducer,\n\t\tstore,\n\t\tactions,\n\t\tselectors,\n\t\tresolvers,\n\t\tgetSelectors,\n\t\tgetActions,\n\t\tsubscribe,\n\t};\n}\n\n/**\n * Creates a redux store for a namespace.\n *\n * @param {Function} reducer    Root reducer for redux store.\n * @param {string} key          Part of the state shape to register the\n *                              selectors for.\n * @param {Object} registry     Registry reference, for resolver enhancer support.\n * @return {Object}             Newly created redux store.\n */\nfunction createReduxStore( reducer, key, registry ) {\n\tconst enhancers = [\n\t\tapplyMiddleware( createResolversCacheMiddleware( registry, key ), promise ),\n\t];\n\tif ( typeof window !== 'undefined' && window.__REDUX_DEVTOOLS_EXTENSION__ ) {\n\t\tenhancers.push( window.__REDUX_DEVTOOLS_EXTENSION__( { name: key, instanceId: key } ) );\n\t}\n\n\treturn createStore( reducer, flowRight( enhancers ) );\n}\n\n/**\n * Maps selectors to a redux store.\n *\n * @param {Object} selectors  Selectors to register. Keys will be used as the\n *                            public facing API. Selectors will get passed the\n *                            state as first argument.\n * @param {Object} store      The redux store to which the selectors should be mapped.\n * @return {Object}           Selectors mapped to the redux store provided.\n */\nfunction mapSelectors( selectors, store ) {\n\tconst createStateSelector = ( selector ) => function runSelector() {\n\t\t// This function is an optimized implementation of:\n\t\t//\n\t\t//   selector( store.getState(), ...arguments )\n\t\t//\n\t\t// Where the above would incur an `Array#concat` in its application,\n\t\t// the logic here instead efficiently constructs an arguments array via\n\t\t// direct assignment.\n\t\tconst argsLength = arguments.length;\n\t\tconst args = new Array( argsLength + 1 );\n\t\targs[ 0 ] = store.getState();\n\t\tfor ( let i = 0; i < argsLength; i++ ) {\n\t\t\targs[ i + 1 ] = arguments[ i ];\n\t\t}\n\n\t\treturn selector( ...args );\n\t};\n\n\treturn mapValues( selectors, createStateSelector );\n}\n\n/**\n * Maps actions to dispatch from a given store.\n *\n * @param {Object} actions    Actions to register.\n * @param {Object} store      The redux store to which the actions should be mapped.\n * @return {Object}           Actions mapped to the redux store provided.\n */\nfunction mapActions( actions, store ) {\n\tconst createBoundAction = ( action ) => ( ...args ) => store.dispatch( action( ...args ) );\n\treturn mapValues( actions, createBoundAction );\n}\n\n/**\n * Returns resolvers with matched selectors for a given namespace.\n * Resolvers are side effects invoked once per argument set of a given selector call,\n * used in ensuring that the data needs for the selector are satisfied.\n *\n * @param {Object} resolvers   Resolvers to register.\n * @param {Object} selectors   The current selectors to be modified.\n * @param {Object} fulfillment Fulfillment implementation functions.\n * @param {Object} store       The redux store to which the resolvers should be mapped.\n * @return {Object}            An object containing updated selectors and resolvers.\n */\nfunction mapResolvers( resolvers, selectors, fulfillment, store ) {\n\tconst mapSelector = ( selector, selectorName ) => {\n\t\tconst resolver = resolvers[ selectorName ];\n\t\tif ( ! resolver ) {\n\t\t\treturn selector;\n\t\t}\n\n\t\treturn ( ...args ) => {\n\t\t\tasync function fulfillSelector() {\n\t\t\t\tconst state = store.getState();\n\t\t\t\tif ( typeof resolver.isFulfilled === 'function' && resolver.isFulfilled( state, ...args ) ) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tif ( fulfillment.hasStarted( selectorName, args ) ) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tfulfillment.start( selectorName, args );\n\t\t\t\tawait fulfillment.fulfill( selectorName, ...args );\n\t\t\t\tfulfillment.finish( selectorName, args );\n\t\t\t}\n\n\t\t\tfulfillSelector( ...args );\n\t\t\treturn selector( ...args );\n\t\t};\n\t};\n\n\tconst mappedResolvers = mapValues( resolvers, ( resolver ) => {\n\t\tconst { fulfill: resolverFulfill = resolver } = resolver;\n\t\treturn { ...resolver, fulfill: resolverFulfill };\n\t} );\n\n\treturn {\n\t\tresolvers: mappedResolvers,\n\t\tselectors: mapValues( selectors, mapSelector ),\n\t};\n}\n\n/**\n * Bundles up fulfillment functions for resolvers.\n * @param {Object} registry     Registry reference, for fulfilling via resolvers\n * @param {string} key          Part of the state shape to register the\n *                              selectors for.\n * @return {Object}             An object providing fulfillment functions.\n */\nfunction getCoreDataFulfillment( registry, key ) {\n\tconst { hasStartedResolution } = registry.select( 'core/data' );\n\tconst { startResolution, finishResolution } = registry.dispatch( 'core/data' );\n\n\treturn {\n\t\thasStarted: ( ...args ) => hasStartedResolution( key, ...args ),\n\t\tstart: ( ...args ) => startResolution( key, ...args ),\n\t\tfinish: ( ...args ) => finishResolution( key, ...args ),\n\t\tfulfill: ( ...args ) => fulfillWithRegistry( registry, key, ...args ),\n\t};\n}\n\n/**\n * Calls a resolver given arguments\n *\n * @param {Object} registry     Registry reference, for fulfilling via resolvers\n * @param {string} key          Part of the state shape to register the\n *                              selectors for.\n * @param {string} selectorName Selector name to fulfill.\n * @param {Array} args         Selector Arguments.\n */\nasync function fulfillWithRegistry( registry, key, selectorName, ...args ) {\n\tconst namespace = registry.stores[ key ];\n\tconst resolver = get( namespace, [ 'resolvers', selectorName ] );\n\tif ( ! resolver ) {\n\t\treturn;\n\t}\n\n\tconst action = resolver.fulfill( ...args );\n\tif ( action ) {\n\t\tawait namespace.store.dispatch( action );\n\t}\n}\n"]}