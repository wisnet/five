{"version":3,"sources":["/Users/riad/Workspace/a8c/gutenberg/packages/blocks/src/api/raw-handling/shortcode-converter.js"],"names":["some","castArray","first","mapValues","pickBy","includes","regexp","next","createBlock","getBlockTransforms","findTransform","getBlockType","getBlockAttributes","segmentHTMLToShortcodeBlock","HTML","lastIndex","transformsFrom","transformation","transform","type","tag","test","transformTags","transformTag","match","beforeHTML","substr","index","content","length","shortcode","attributes","schema","attrs","block","blockName"],"mappings":";;;AAAA;;;AAGA,SAASA,IAAT,EAAeC,SAAf,EAA0BC,KAA1B,EAAiCC,SAAjC,EAA4CC,MAA5C,EAAoDC,QAApD,QAAoE,QAApE;AAEA;;;;AAGA,SAASC,MAAT,EAAiBC,IAAjB,QAA6B,sBAA7B;AAEA;;;;AAGA,SAASC,WAAT,EAAsBC,kBAAtB,EAA0CC,aAA1C,QAA+D,YAA/D;AACA,SAASC,YAAT,QAA6B,iBAA7B;AACA,SAASC,kBAAT,QAAmC,WAAnC;;AAEA,SAASC,2BAAT,CAAsCC,IAAtC,EAA4D;AAAA,MAAhBC,SAAgB,uEAAJ,CAAI;AAC3D;AACA,MAAMC,cAAc,GAAGP,kBAAkB,CAAE,MAAF,CAAzC;AAEA,MAAMQ,cAAc,GAAGP,aAAa,CAAEM,cAAF,EAAkB,UAAEE,SAAF;AAAA,WACrDA,SAAS,CAACC,IAAV,KAAmB,WAAnB,IACAnB,IAAI,CAAEC,SAAS,CAAEiB,SAAS,CAACE,GAAZ,CAAX,EAA8B,UAAEA,GAAF;AAAA,aAAWd,MAAM,CAAEc,GAAF,CAAN,CAAcC,IAAd,CAAoBP,IAApB,CAAX;AAAA,KAA9B,CAFiD;AAAA,GAAlB,CAApC;;AAKA,MAAK,CAAEG,cAAP,EAAwB;AACvB,WAAO,CAAEH,IAAF,CAAP;AACA;;AAED,MAAMQ,aAAa,GAAGrB,SAAS,CAAEgB,cAAc,CAACG,GAAjB,CAA/B;AACA,MAAMG,YAAY,GAAGrB,KAAK,CAAEoB,aAAF,CAA1B;AAEA,MAAIE,KAAJ;;AAEA,MAAOA,KAAK,GAAGjB,IAAI,CAAEgB,YAAF,EAAgBT,IAAhB,EAAsBC,SAAtB,CAAnB,EAAyD;AACxD,QAAMU,UAAU,GAAGX,IAAI,CAACY,MAAL,CAAa,CAAb,EAAgBF,KAAK,CAACG,KAAtB,CAAnB;AAEAZ,IAAAA,SAAS,GAAGS,KAAK,CAACG,KAAN,GAAcH,KAAK,CAACI,OAAN,CAAcC,MAAxC,CAHwD,CAKxD;AACA;AACA;AACA;;AACA,QACC,CAAExB,QAAQ,CAAEmB,KAAK,CAACM,SAAN,CAAgBF,OAAhB,IAA2B,EAA7B,EAAiC,GAAjC,CAAV,IACA,CAAE,eAAeP,IAAf,CAAqBI,UAArB,CAFH,EAGE;AACD,aAAOZ,2BAA2B,CAAEC,IAAF,EAAQC,SAAR,CAAlC;AACA;;AAED,QAAMgB,UAAU,GAAG5B,SAAS,CAC3BC,MAAM,CAAEa,cAAc,CAACc,UAAjB,EAA6B,UAAEC,MAAF;AAAA,aAAcA,MAAM,CAACF,SAArB;AAAA,KAA7B,CADqB,EAE3B;AACA;AACA;AACA;AACA,cAAEE,MAAF;AAAA,aAAcA,MAAM,CAACF,SAAP,CAAkBN,KAAK,CAACM,SAAN,CAAgBG,KAAlC,EAAyCT,KAAzC,CAAd;AAAA,KAN2B,CAA5B;AASA,QAAMU,KAAK,GAAG1B,WAAW,CACxBS,cAAc,CAACkB,SADS,EAExBvB,kBAAkB,mBAEbD,YAAY,CAAEM,cAAc,CAACkB,SAAjB,CAFC;AAGhBJ,MAAAA,UAAU,EAAEd,cAAc,CAACc;AAHX,QAKjBP,KAAK,CAACM,SAAN,CAAgBF,OALC,EAMjBG,UANiB,CAFM,CAAzB;AAYA,YACCN,UADD,EAECS,KAFD,4BAGIrB,2BAA2B,CAAEC,IAAI,CAACY,MAAL,CAAaX,SAAb,CAAF,CAH/B;AAKA;;AAED,SAAO,CAAED,IAAF,CAAP;AACA;;AAED,eAAeD,2BAAf","sourcesContent":["/**\n * External dependencies\n */\nimport { some, castArray, first, mapValues, pickBy, includes } from 'lodash';\n\n/**\n * WordPress dependencies\n */\nimport { regexp, next } from '@wordpress/shortcode';\n\n/**\n * Internal dependencies\n */\nimport { createBlock, getBlockTransforms, findTransform } from '../factory';\nimport { getBlockType } from '../registration';\nimport { getBlockAttributes } from '../parser';\n\nfunction segmentHTMLToShortcodeBlock( HTML, lastIndex = 0 ) {\n\t// Get all matches.\n\tconst transformsFrom = getBlockTransforms( 'from' );\n\n\tconst transformation = findTransform( transformsFrom, ( transform ) => (\n\t\ttransform.type === 'shortcode' &&\n\t\tsome( castArray( transform.tag ), ( tag ) => regexp( tag ).test( HTML ) )\n\t) );\n\n\tif ( ! transformation ) {\n\t\treturn [ HTML ];\n\t}\n\n\tconst transformTags = castArray( transformation.tag );\n\tconst transformTag = first( transformTags );\n\n\tlet match;\n\n\tif ( ( match = next( transformTag, HTML, lastIndex ) ) ) {\n\t\tconst beforeHTML = HTML.substr( 0, match.index );\n\n\t\tlastIndex = match.index + match.content.length;\n\n\t\t// If the shortcode content does not contain HTML and the shortcode is\n\t\t// not on a new line (or in paragraph from Markdown converter),\n\t\t// consider the shortcode as inline text, and thus skip conversion for\n\t\t// this segment.\n\t\tif (\n\t\t\t! includes( match.shortcode.content || '', '<' ) &&\n\t\t\t! /(\\n|<p>)\\s*$/.test( beforeHTML )\n\t\t) {\n\t\t\treturn segmentHTMLToShortcodeBlock( HTML, lastIndex );\n\t\t}\n\n\t\tconst attributes = mapValues(\n\t\t\tpickBy( transformation.attributes, ( schema ) => schema.shortcode ),\n\t\t\t// Passing all of `match` as second argument is intentionally broad\n\t\t\t// but shouldn't be too relied upon.\n\t\t\t//\n\t\t\t// See: https://github.com/WordPress/gutenberg/pull/3610#discussion_r152546926\n\t\t\t( schema ) => schema.shortcode( match.shortcode.attrs, match ),\n\t\t);\n\n\t\tconst block = createBlock(\n\t\t\ttransformation.blockName,\n\t\t\tgetBlockAttributes(\n\t\t\t\t{\n\t\t\t\t\t...getBlockType( transformation.blockName ),\n\t\t\t\t\tattributes: transformation.attributes,\n\t\t\t\t},\n\t\t\t\tmatch.shortcode.content,\n\t\t\t\tattributes,\n\t\t\t)\n\t\t);\n\n\t\treturn [\n\t\t\tbeforeHTML,\n\t\t\tblock,\n\t\t\t...segmentHTMLToShortcodeBlock( HTML.substr( lastIndex ) ),\n\t\t];\n\t}\n\n\treturn [ HTML ];\n}\n\nexport default segmentHTMLToShortcodeBlock;\n"]}